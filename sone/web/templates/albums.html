{{template "base" .}}

{{define "content"}}
<div class="page-albums">
    <div class="albums-header">
        <h1>{{.ViewedSone.Name}}'s Albums</h1>
        <a href="/sone/{{.ViewedSone.ID}}" class="btn btn-secondary">Back to Profile</a>
    </div>

    {{if .IsOwnSone}}
    <div class="upload-section">
        <h2>Upload Image</h2>
        <form id="upload-form" enctype="multipart/form-data" onsubmit="return uploadImage(event)">
            <div class="form-group">
                <label for="image">Select Image:</label>
                <input type="file" id="image" name="image" accept="image/*" required>
            </div>
            <div class="form-group">
                <label for="album">Album:</label>
                <select id="album" name="album">
                    <option value="root">Root Album</option>
                    {{range .Albums}}
                    {{template "album-options" .}}
                    {{end}}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div id="upload-progress" style="display: none;">
            <p>Uploading... <span id="progress-percent">0%</span></p>
        </div>
    </div>

    <div class="create-album-section">
        <h2>Create Album</h2>
        <form onsubmit="return createAlbum(event)">
            <div class="form-group">
                <label for="album-title">Album Title:</label>
                <input type="text" id="album-title" name="title" required>
            </div>
            <div class="form-group">
                <label for="parent-album">Parent Album:</label>
                <select id="parent-album" name="parentId">
                    <option value="">Root</option>
                    {{range .Albums}}
                    {{template "album-options" .}}
                    {{end}}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Create Album</button>
        </form>
    </div>
    {{end}}

    <div class="albums-list">
        <h2>Albums</h2>
        {{if .Albums}}
        {{range .Albums}}
        {{template "album-view" .}}
        {{end}}
        {{else}}
        <p class="empty-state">No albums yet.</p>
        {{end}}
    </div>
</div>

<script>
async function uploadImage(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    document.getElementById('upload-progress').style.display = 'block';

    try {
        const response = await fetch('/ajax/upload-image', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();

        if (result.success) {
            alert('Image upload started! It may take a while to complete.');
            window.location.reload();
        } else {
            alert('Upload failed: ' + result.error);
        }
    } catch (e) {
        alert('Upload failed: ' + e.message);
    }

    document.getElementById('upload-progress').style.display = 'none';
    return false;
}

async function createAlbum(event) {
    event.preventDefault();
    const title = document.getElementById('album-title').value;
    const parentId = document.getElementById('parent-album').value;

    const response = await fetch('/ajax/create-album', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, parentId })
    });
    const result = await response.json();

    if (result.success) {
        window.location.reload();
    } else {
        alert('Failed to create album: ' + result.error);
    }
    return false;
}

async function deleteAlbum(albumId) {
    if (!confirm('Are you sure you want to delete this album and all its contents?')) {
        return;
    }

    const response = await fetch('/ajax/delete-album', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ albumId })
    });
    const result = await response.json();

    if (result.success) {
        window.location.reload();
    } else {
        alert('Failed to delete album: ' + result.error);
    }
}

async function deleteImage(imageId) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }

    const response = await fetch('/ajax/delete-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageId })
    });
    const result = await response.json();

    if (result.success) {
        window.location.reload();
    } else {
        alert('Failed to delete image: ' + result.error);
    }
}
</script>
{{end}}

{{define "album-options"}}
<option value="{{.ID}}">{{.Title}}</option>
{{range .Albums}}
{{template "album-options" .}}
{{end}}
{{end}}

{{define "album-view"}}
<div class="album" data-album-id="{{.ID}}">
    <div class="album-header">
        <h3>{{.Title}}</h3>
        {{if $.IsOwnSone}}
        {{if ne .ID "root"}}
        <button class="btn btn-small" onclick="deleteAlbum('{{.ID}}')">Delete</button>
        {{end}}
        {{end}}
    </div>

    {{if .Images}}
    <div class="image-grid">
        {{range .Images}}
        <div class="image-item" data-image-id="{{.ID}}">
            <a href="/image/{{.Key}}" target="_blank">
                <img src="/image/{{.Key}}" alt="{{.Title}}" loading="lazy">
            </a>
            <div class="image-info">
                <span class="image-title">{{.Title}}</span>
                <span class="image-size">{{.Width}}x{{.Height}}</span>
                {{if $.IsOwnSone}}
                <button class="btn btn-small" onclick="deleteImage('{{.ID}}')">Delete</button>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <p class="empty-album">No images in this album.</p>
    {{end}}

    {{if .Albums}}
    <div class="nested-albums">
        {{range .Albums}}
        {{template "album-view" .}}
        {{end}}
    </div>
    {{end}}
</div>
{{end}}
